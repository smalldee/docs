Interacting with ZetaChain universal apps from the Sui blockchain includes the
ability to withdraw tokens back to Sui while simultaneously executing contract
calls. This functionality allows for seamless cross-chain operations where you
can both withdraw assets and trigger contract logic in a single transaction.

In this tutorial, you'll:

- Set up a local development environment using
  [localnet](/developers/tutorials/localnet).
- Deploy a universal contract on ZetaChain.
- Deploy a mock Cetus pool contract on Sui.
- Execute withdraw-and-call to withdraw tokens and call a contract on Sui in a
  single transaction.

By the end, you'll understand how to perform complex cross-chain operations that
combine asset withdrawals with contract calls on Sui.

## Prerequisites

Ensure you have installed and configured the following tools before starting:

- [Sui CLI](https://docs.sui.io/references/cli): Required for starting a local
  Sui node and interacting with it.
- [Foundry](https://getfoundry.sh/): Needed for encoding payload data using ABI.
- [jq](https://stedolan.github.io/jq/): Required for parsing JSON output from
  Sui CLI.

## Clone the Example Project

Begin by cloning the example contracts repository and installing its
dependencies:

```bash
git clone https://github.com/zeta-chain/example-contracts
cd example-contracts/examples/call
yarn
```

## Launch Localnet

Start your local development environment, which sets up instances of ZetaChain
and Sui:

```bash
npx hardhat localnet
```

Keep this terminal window open. You should see a table displaying the deployment
details, including Gateway module and object IDs.

## Deploying a Universal Contract

Open a new terminal window to compile and deploy your Universal Contract:

```bash
npx hardhat compile --force
npx hardhat deploy --name Universal --network localhost --gateway 0x5FC8d32690cc91D4c39d9d3abcBD16989F875707
```

A successful deployment will output the contract address.

## Deploy the Cetus Mock Contract

Navigate to the Sui contract directory and deploy the mock Cetus pool contract:

```bash
cd sui
```

```
sui move build --force
```

```
PUBLISHED=$(sui client publish --skip-dependency-verification --json)
```

```
PACKAGE=$(echo $PUBLISHED | jq -r '.objectChanges[] | select(.type == "published") | .packageId')
```

This will deploy the contract and store the package ID in the `$PACKAGE`
variable.

## Set Up the Pool

After deployment, you'll need to set up the pool by minting tokens and creating
the initial liquidity.

Get the treasury cap:

```bash
TREASURY=$(echo $PUBLISHED | jq -r --arg pkg "$PACKAGE" '.objectChanges[] | select(.type == "created" and .objectType == "0x2::coin::TreasuryCap<\($pkg)::token::TOKEN>") | .objectId')
```

Get the pool ID:

```
POOL=$(echo $PUBLISHED | jq -r --arg pkg "$PACKAGE" '.objectChanges[] | select(.type == "created" and .objectType == "\($pkg)::cetusmock::Pool<0x2::sui::SUI, \($pkg)::token::TOKEN>") | .objectId')
```

Mint tokens to your address:

```
RECIPIENT=$(sui client active-address)
sui client call \
  --package "$PACKAGE" \
  --module token \
  --function mint \
  --args "$TREASURY" 1000000 "$RECIPIENT"
```

Get the token ID:

```
TOKEN=$(sui client objects --json | jq -r --arg pkg "$PACKAGE" '.[].data | select(.type == "0x2::coin::Coin<\($pkg)::token::TOKEN>") | .objectId')
```

Deposit tokens into the pool:

```
sui client call \
  --package "$PACKAGE" \
  --module cetusmock \
  --function deposit \
  --type-args "0x2::sui::SUI" "$PACKAGE::token::TOKEN" \
  --args "$POOL" "$TOKEN"
```

## Execute Withdraw and Call

Now you can execute the withdraw and call operation. This will withdraw tokens
from ZetaChain to Sui and simultaneously call the Cetus pool contract.

Get the required contract IDs:

```bash
CONFIG=$(echo $PUBLISHED | jq -r --arg pkg "$PACKAGE" '.objectChanges[] | select(.type == "created" and .objectType == "\($pkg)::cetusmock::GlobalConfig") | .objectId')
```

```
CLOCK=$(echo $PUBLISHED | jq -r --arg pkg "$PACKAGE" '.objectChanges[] | select(.type == "created" and .objectType == "\($pkg)::cetusmock::Clock") | .objectId')
```

```
PARTNER=$(echo $PUBLISHED | jq -r --arg pkg "$PACKAGE" '.objectChanges[] | select(.type == "created" and .objectType == "\($pkg)::cetusmock::Partner") | .objectId')
```

Prepare the payload:

```
MESSAGE=$RECIPIENT
```

```
TOKEN_TYPE="$PACKAGE::token::TOKEN"
```

```
PAYLOAD=$(npx ts-node ./setup/encodeCallArgs.ts "$TOKEN_TYPE" "$CONFIG,$POOL,$PARTNER,$CLOCK" "$MESSAGE")
```

# Execute the withdraw and call

```
cast send 0x5FC8d32690cc91D4c39d9d3abcBD16989F875707 "withdrawAndCall(bytes,uint256,address,bytes,(uint256,bool),(address,bool,address,bytes,uint256))" \
  "$PACKAGE" \
  "1000000" \
  "0xd97B1de3619ed2c6BEb3860147E30cA8A7dC9891" \
  "$PAYLOAD" \
  "(10000,false)" \
  "(0xB0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48,true,0xC0b86991c6218b36c1d19D4a2e9Eb0cE3606eB49,0xdeadbeef,50000)" \
  --private-key ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

This transaction will:

1. Withdraw tokens from ZetaChain to Sui
2. Call the Cetus pool contract with the specified parameters
3. Execute the contract logic on Sui

The operation demonstrates how to perform complex cross-chain operations that
combine asset withdrawals with contract calls, enabling sophisticated DeFi
interactions between ZetaChain and Sui.
